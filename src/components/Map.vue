<template>
  <div class="map-container">
    <gislife-map v-if="appConfig.baseUrl" v-on="$listeners" ref="map" :appcode="appConfig.appCode"
      :baseUrl="appConfig.baseUrl" :requestHeader="requestHeader" @onLoad="handleMapLoad" @onMapClick="handleMapClick" />
  </div>
</template>

<script>

const PIPE_LAYER_ID = 'pipe-line';
const STATION_IMG_MAP = {
  1: require('@/assets/images/处理厂.png'),
  2: require('@/assets/images/净化厂.png'),
  4: require('@/assets/images/集注站.png'),
  8: require('@/assets/images/集气站.png'),
  9: require('@/assets/images/脱水站.png'),
  10: require('@/assets/images/阀室.png'),
  21: require('@/assets/images/输气站.png'),
  22: require('@/assets/images/配气站.png'),
  24: require('@/assets/images/采气站.png'),
  25: require('@/assets/images/输配气站.png'),
  26: require('@/assets/images/T节点.png'),
  99: require('@/assets/images/其他场站.png'),
}

export default {
  data() {
    return {
      requestHeader: {
        token: sessionStorage.token
      },
      appConfig: window.URL_CONFIG
    }
  },
  mounted() {

  },
  methods: {
    handleMapClick(e) {
      console.log(e);
    },
    handleMapLoad() {
      this.$nextTick(() => {
        this.pipeRender([{
          name: '测试管道1',
          wkt: 'LINESTRING (107.860121564 31.1978979020001, 107.860107553 31.1979336950001, 107.860105901 31.198059062, 107.860164886 31.1981098950001, 107.860083999 31.198179172)'
        }, {
          name: '测试管道2',
          wkt: 'LINESTRING (107.376970305 30.8677165300001, 107.376765736 30.8677888780001, 107.376683899 30.867833487, 107.375671359 30.8674578160001, 107.375084888 30.867215881, 107.373450123 30.866987002, 107.372691261 30.8669822360001, 107.371671114 30.8670398020001, 107.369933382 30.8670962, 107.368651437 30.867023214, 107.36714299 30.8668753200001, 107.366388336 30.866755009, 107.365420467 30.866718341, 107.364454666 30.8667955020001, 107.36404567 30.8669473620001, 107.36289894 30.8675211390001, 107.362287186 30.86780062, 107.361030632 30.8683770910001, 107.360477292 30.8685989360001, 107.359886829 30.8688659790001, 107.359095449 30.8691740470001, 107.358858222 30.8692329400001, 107.358406238 30.869274628, 107.357681215 30.8691627960001, 107.355908307 30.8694223250001, 107.35495588 30.869497218, 107.354089751 30.8696278260001, 107.353066938 30.8697507950001, 107.35249461 30.8698529270001, 107.351122925 30.8702468880001, 107.350207044 30.8706519580001, 107.349702123 30.8718417150001, 107.348936088 30.8726440300001, 107.348765688 30.873118408, 107.348470793 30.873152825, 107.347914273 30.873124498, 107.347681098 30.8730600860001, 107.347369335 30.872898428, 107.346155449 30.872356634, 107.344880038 30.8724536390001, 107.34465632 30.8725690380001, 107.343911307 30.872904577, 107.342516264 30.8735845960001, 107.341240973 30.87413417, 107.340031125 30.8746844180001, 107.339081806 30.8751952160001, 107.338171417 30.875685021, 107.337744631 30.8757363230001, 107.336894563 30.8758620300001, 107.335040364 30.875799581, 107.334542388 30.875696454, 107.334002078 30.875832663, 107.333190688 30.8760501830001, 107.33297959 30.8761063740001, 107.332749754 30.876136215, 107.331705052 30.876280636, 107.330641833 30.876425775, 107.330370748 30.876461083, 107.329899782 30.8765190710001, 107.329547312 30.876573804, 107.329254146 30.8766109740001, 107.328758456 30.876676316, 107.328630256 30.8766760120001, 107.328194696 30.876754211, 107.32760363 30.8766862910001, 107.327065987 30.8765431520001, 107.32703481 30.8765306290001, 107.326792659 30.876451618, 107.325669349 30.8760513550001, 107.324909084 30.875940241, 107.324855457 30.875937245, 107.324152273 30.875917169, 107.323530607 30.8762586510001, 107.323225567 30.8760966940001, 107.322783474 30.875737201, 107.322587186 30.8755606450001, 107.322514723 30.875486955, 107.322418324 30.87539544, 107.322351426 30.875331504, 107.322332638 30.8752968490001, 107.322072261 30.875386953, 107.322032635 30.87540153, 107.321518253 30.8755660630001, 107.321429556 30.875301592, 107.320948085 30.875336045, 107.320927703 30.875142834, 107.321023331 30.8751353070001)'
        }])
        this.pipeSectionPointRender(['POINT (107.335040364 30.875799581)', 'POINT (107.359095449 30.8691740470001)', 'POINT (107.376683899 30.867833487)'])
        this.stationRender([{
          wkt: 'POINT (107.376970305 30.8677165300001)',
          name: '起点场站',
          type: 1
        }, {
          wkt: 'POINT (107.321023331 30.8751353070001)',
          name: '终点场站',
          type: 2
        }])
        this.renderMarkerByType([{
          wkt: 'POINT (107.38554762638205 30.876412150137227)',
          name: '测试人居1',
          mobile: '13688474857'
        }, {
          wkt: 'POINT (107.3314041423302 30.866465335832338)',
          name: '测试人居2',
          mobile: '13688474858'
        }], 1)

        this.renderMarkerByType([{
          wkt: 'POINT (107.35273339362271 30.86390172389794)',
          name: '测试特定场所1',
          mobile: '13688474857'
        }, {
          wkt: 'POINT (107.3925206508423 30.87302818238389)',
          name: '测试特定场所2',
          mobile: '13688474858'
        }], 2)
        this.sectionLevelRender([{
          level: 0,
          wkt: 'LINESTRING (107.376970305 30.8677165300001, 107.376765736 30.8677888780001, 107.376683899 30.867833487, 107.375671359 30.8674578160001, 107.375084888 30.867215881, 107.373450123 30.866987002, 107.372691261 30.8669822360001, 107.371671114 30.8670398020001, 107.369933382 30.8670962, 107.368651437 30.867023214, 107.36714299 30.8668753200001, 107.366388336 30.866755009, 107.365420467 30.866718341, 107.364454666 30.8667955020001, 107.36404567 30.8669473620001, 107.36289894 30.8675211390001, 107.362287186 30.86780062, 107.361030632 30.8683770910001)'
        }, {
          level: 1,
          wkt: 'LINESTRING (107.360477292 30.8685989360001, 107.359886829 30.8688659790001, 107.359095449 30.8691740470001, 107.358858222 30.8692329400001, 107.358406238 30.869274628, 107.357681215 30.8691627960001, 107.355908307 30.8694223250001, 107.35495588 30.869497218)'
        }, {
          level: 2,
          wkt: 'LINESTRING (107.354089751 30.8696278260001, 107.353066938 30.8697507950001, 107.35249461 30.8698529270001, 107.351122925 30.8702468880001, 107.350207044 30.8706519580001, 107.349702123 30.8718417150001, 107.348936088 30.8726440300001, 107.348765688 30.873118408, 107.348470793 30.873152825, 107.347914273 30.873124498, 107.347681098 30.8730600860001, 107.347369335 30.872898428, 107.346155449 30.872356634, 107.344880038 30.8724536390001, 107.34465632 30.8725690380001, 107.343911307 30.872904577, 107.342516264 30.8735845960001, 107.341240973 30.87413417, 107.340031125 30.8746844180001, 107.339081806 30.8751952160001, 107.338171417 30.875685021, 107.337744631 30.8757363230001, 107.336894563 30.8758620300001, 107.335040364 30.875799581, 107.334542388 30.875696454, 107.334002078 30.875832663, 107.333190688 30.8760501830001)'
        }, {
          level: 3,
          wkt: 'LINESTRING (107.33297959 30.8761063740001, 107.332749754 30.876136215, 107.331705052 30.876280636, 107.330641833 30.876425775, 107.330370748 30.876461083, 107.329899782 30.8765190710001, 107.329547312 30.876573804, 107.329254146 30.8766109740001, 107.328758456 30.876676316, 107.328630256 30.8766760120001, 107.328194696 30.876754211, 107.32760363 30.8766862910001, 107.327065987 30.8765431520001, 107.32703481 30.8765306290001, 107.326792659 30.876451618, 107.325669349 30.8760513550001, 107.324909084 30.875940241, 107.324855457 30.875937245, 107.324152273 30.875917169, 107.323530607 30.8762586510001, 107.323225567 30.8760966940001, 107.322783474 30.875737201, 107.322587186 30.8755606450001, 107.322514723 30.875486955, 107.322418324 30.87539544, 107.322351426 30.875331504, 107.322332638 30.8752968490001, 107.322072261 30.875386953, 107.322032635 30.87540153, 107.321518253 30.8755660630001, 107.321429556 30.875301592, 107.320948085 30.875336045, 107.320927703 30.875142834, 107.321023331 30.8751353070001)',
        }]);
        this.pipeRadiusRender('POLYGON ((107.377763626415 30.8693856523664, 107.3777156487 30.8694026202786, 107.377467772017 30.8695059280157, 107.377206311474 30.8695802548007, 107.376935797942 30.8696243126125, 107.376660919198 30.8696373379646, 107.376386438676 30.869619105138, 107.37611711291 30.8695699300931, 107.375857609089 30.8694906649938, 107.374845054892 30.8691149876274, 107.374806914052 30.8691004460252, 107.374769116932 30.8690852513045, 107.374453498207 30.8689550501364, 107.373273948092 30.8687899038395, 107.372751985169 30.8687866255035, 107.371807616039 30.8688399151354, 107.371778696575 30.8688413734736, 107.371749756467 30.868842486117, 107.370011991993 30.8688988851566, 107.369903789653 30.8688999794676, 107.369795666547 30.8688962443562, 107.368513697696 30.8688232570127, 107.368464436676 30.8688199475426, 107.368415280048 30.8688156350834, 107.366906805343 30.8686677383727, 107.366834682876 30.8686595684464, 107.366762933442 30.8686492397678, 107.366151285524 30.8685517278932, 107.36547125433 30.8685259647117, 107.364980288352 30.8685651899524, 107.363948233337 30.8690815901822, 107.363913167943 30.8690987478158, 107.36387772564 30.8691153191965, 107.363267577334 30.8693940663069, 107.362012621412 30.8699698082509, 107.361962685823 30.8699919801876, 107.361912078003 30.8700129874473, 107.361404089794 30.8702166508363, 107.360857919082 30.870463663111, 107.360802896269 30.8704876624126, 107.360747077166 30.8705102521186, 107.359955686408 30.8708183252991, 107.359816632279 30.8708673499305, 107.359673856975 30.8709076377442, 107.359436626059 30.8709665317884, 107.359260114999 30.8710032759249, 107.359080574135 30.87102667429, 107.358628581814 30.8710683630547, 107.358431399073 30.8710784569065, 107.358233991856 30.8710724584202, 107.358038121341 30.8710504211116, 107.357671833445 30.8709939231396, 107.356258194701 30.8712008581097, 107.356178385169 30.8712111782106, 107.356098173453 30.8712188345594, 107.355231341152 30.8712869972018, 107.354449879607 30.8714048375282, 107.354414215914 30.8714099416999, 107.354378455263 30.8714145133482, 107.353423504662 30.8715293237743, 107.353038663636 30.8715979988226, 107.351935058072 30.8719149655767, 107.351889576448 30.8719350811396, 107.351666035466 30.8724618372758, 107.35157275139 30.872648374768, 107.351455743346 30.8728246822531, 107.351316495149 30.8729885237326, 107.350812019287 30.8735169031612, 107.350763388528 30.8736522940469, 107.350669594305 30.8738649414916, 107.350545514726 30.8740657142581, 107.350393123344 30.8742514186539, 107.350214844107 30.8744191006618, 107.350013512811 30.8745660929338, 107.349792331988 30.8746900572263, 107.349554819966 30.8747890215993, 107.349304754895 30.8748614117893, 107.349046114646 30.8749060762552, 107.348751214273 30.8749404938846, 107.348549774867 30.874955496534, 107.348347597247 30.8749536509035, 107.347791066877 30.8749253233817, 107.347530719843 30.8748978599595, 107.347276405606 30.8748425048724, 107.347043226873 30.8747780917406, 107.346817627599 30.874703115558, 107.346603567578 30.8746061830273, 107.346348968239 30.8744741653772, 107.34573392531 30.8741996537359, 107.345517843029 30.8742160883563, 107.344910063498 30.874489821034, 107.343545221149 30.8751551216539, 107.34349843018 30.8751772552265, 107.343450999712 30.8751983518378, 107.342196190608 30.8757391016442, 107.341073708865 30.8762496173539, 107.3401887243 30.876725801504, 107.339278298518 30.8772156292073, 107.339020334031 30.8773336915719, 107.338745818022 30.8774196105921, 107.33846010276 30.8774717110851, 107.338065761412 30.8775191131167, 107.337247972993 30.8776400465768, 107.337031218768 30.8776621327112, 107.336812976217 30.8776646145462, 107.334958742561 30.8776021643945, 107.334776553442 30.8775891301583, 107.334596380048 30.8775624228411, 107.33380943385 30.8777733882399, 107.333596330895 30.8778301149061, 107.333444928038 30.877865113859, 107.333290911358 30.8778902342691, 107.333070909398 30.8779187571283, 107.33203401397 30.8780621385829, 107.330961441574 30.8782085332289, 107.330674671927 30.8782458772362, 107.330233034145 30.8783002816597, 107.329917887617 30.8783492188839, 107.329884730091 30.878354130535, 107.329851485256 30.878358581525, 107.329564218544 30.8783949887173, 107.329074424182 30.8784595684225, 107.328964768611 30.8784714750739, 107.328854536905 30.8784783688653, 107.328620902977 30.8785203145507, 107.328388226606 30.8785504287649, 107.328153100987 30.878557811606, 107.327918501779 30.8785423696399, 107.327327424998 30.8784744483976, 107.327155542167 30.8784483607116, 107.326986779521 30.878410003604, 107.326449127813 30.87826686208, 107.326338599109 30.8782344949861, 107.326230336122 30.8781968597742, 107.326052646906 30.8781388817026, 107.326023290324 30.8781290844993, 107.32599410802 30.8781189073272, 107.32508810957 30.8777960779323, 107.324722523435 30.8777426467911, 107.324654069006 30.8777802488702, 107.324397182269 30.8779004744002, 107.324123372546 30.8779886385912, 107.32383798692 30.8780430197206, 107.323546598574 30.8780625557992, 107.323254897933 30.8780468653135, 107.322968581523 30.8779962546777, 107.322693240705 30.8779117122486, 107.32243425247 30.8777948890215, 107.322129209447 30.8776329294762, 107.321953420141 30.8775285680558, 107.321790876017 30.8774092989308, 107.321731059496 30.8773606581065, 107.321442627386 30.8773688410073, 107.321155635215 30.8773426996306, 107.320875547414 30.8772827317173, 107.320607696932 30.8771900790755, 107.320357183678 30.8770665058373, 107.320097072607 30.8769839106647, 107.31985190917 30.8768723725387, 107.319625999481 30.8767338505693, 107.319423311424 30.8765707778149, 107.319247404959 30.8763860185407, 107.319101369587 30.8761828179045, 107.318987770102 30.8759647449512, 107.318908601542 30.8757356299208, 107.318865254169 30.8754994969694, 107.318844876313 30.8753062856463, 107.318837961394 30.8750704311674, 107.318866790598 30.8748358153869, 107.318930870556 30.8746064512917, 107.319029104975 30.8743862620132, 107.319159813401 30.8741790137275, 107.319320759974 30.8739882512416, 107.319509191689 30.8738172373668, 107.319721885482 30.8736688971169, 107.319955203364 30.8735457676849, 107.320205154644 30.8734499550523, 107.320467464179 30.8733830979739, 107.320737645488 30.8733463399535, 107.320833271719 30.8733388130919, 107.321123052432 30.8733334004956, 107.321410917842 30.8733625975671, 107.321691339045 30.873425843531, 107.321958930092 30.8735219236484, 107.322229569346 30.8734950826758, 107.322501957304 30.8734988123678, 107.32277147252 30.873533049445, 107.323033542276 30.8735972130258, 107.323283720159 30.8736902144809, 107.323517761485 30.8738104759, 107.323731695311 30.8739559568599, 107.323921891806 30.8741241890383, 107.324071471738 30.8741145576995, 107.324221467271 30.8741141984516, 107.324924638121 30.8741342740814, 107.324957649817 30.8741354417043, 107.32499063601 30.8741370589912, 107.325044262012 30.8741400549361, 107.325151696385 30.8741484617249, 107.325258485314 30.8741616355233, 107.326018736676 30.8742727475019, 107.326246928492 30.8743175524515, 107.326467888431 30.8743840671487, 107.327562087987 30.8747739564946, 107.327774792501 30.8748433592686, 107.327779322772 30.8748448426101, 107.327783849046 30.8748463350012, 107.328053266781 30.8749180632182, 107.328117513202 30.8749254458861, 107.32820405699 30.8749099079822, 107.328401247011 30.8748829012945, 107.32860052406 30.8748722363805, 107.328944084923 30.8748269580535, 107.329209804562 30.8747932547731, 107.329529213738 30.8747436555673, 107.329566669842 30.8747381416909, 107.329604235897 30.8747332156707, 107.330066835318 30.8746762875629, 107.330322236239 30.8746430154957, 107.331376102182 30.8744991320953, 107.332428610473 30.8743536715882, 107.332512771729 30.8743427299635, 107.332571964276 30.8743269743482, 107.333381339693 30.8741099928375, 107.333398336154 30.8741055045434, 107.333415376224 30.8741011410091, 107.333955677339 30.8739649344215, 107.334220852171 30.8739139425941, 107.334491452762 30.87389303089, 107.334762912859 30.873902552184, 107.335030651709 30.873942345809, 107.335328071724 30.8740039394159, 107.336757164174 30.8740520710076, 107.337391218812 30.8739583072601, 107.337416574082 30.8739546958404, 107.337441978882 30.8739513534218, 107.337974922874 30.873664620672, 107.338924204716 30.8731538457027, 107.338989260309 30.8731202387455, 107.339055685548 30.8730886881459, 107.340265519075 30.8725384491268, 107.340285844542 30.8725293272262, 107.34030628464 30.8725203979407, 107.341533810475 30.8719914102854, 107.342882367919 30.8713340537111, 107.342912720869 30.8713195431204, 107.342943348763 30.8713054689572, 107.34363481019 30.8709940500723, 107.343806686032 30.8709053929046, 107.3440154516 30.870811053479, 107.344235196596 30.8707375740764, 107.344463130447 30.8706858878153, 107.344696358607 30.8706566510605, 107.345971745997 30.8705596478432, 107.346267097578 30.8705552474155, 107.346560221786 30.870586785727, 107.346845270829 30.8706536335921, 107.347116557984 30.8707544574019, 107.347757690139 30.8710406150344, 107.347860918782 30.8709324989518, 107.348243177831 30.8700318134167, 107.348347513051 30.8698264928146, 107.348480564676 30.869633920141, 107.348640277855 30.8694570692538, 107.348824186048 30.8692986712073, 107.34902944912 30.869161172082, 107.349252897206 30.8690466952144, 107.350168766956 30.8686416318643, 107.350313175758 30.8685836436522, 107.35046228213 30.8685353047111, 107.35183394546 30.8681413506068, 107.351951513486 30.8681108593534, 107.352070953027 30.8680863714987, 107.352643270981 30.8679842413438, 107.352710575818 30.8679732190436, 107.352778263054 30.8679641042657, 107.353765249615 30.8678454426969, 107.354595749196 30.8677202073532, 107.354680661509 30.867708947918, 107.354766038251 30.8677007062849, 107.35563803765 30.8676321378838, 107.357331308436 30.8673842661737, 107.35757024178 30.8673613776419, 107.357810641533 30.8673622940815, 107.358049331034 30.8673870033825, 107.35844513669 30.8674480553941, 107.358970394308 30.8672435835976, 107.35950622704 30.8670012485704, 107.359550790304 30.8669816766291, 107.359595883314 30.8669630294232, 107.360098274297 30.8667616117261, 107.361306827113 30.8662071658722, 107.361884554741 30.8659432297107, 107.362996398347 30.8653869110881, 107.363105976135 30.8653357828227, 107.36321888868 30.865290373884, 107.363627878949 30.865138516457, 107.363833159964 30.8650730510422, 107.36404524802 30.8650264514476, 107.364261820216 30.8649992280549, 107.365227603364 30.864922068472, 107.365369799398 30.8649149098691, 107.365512230484 30.8649161178792, 107.366480081413 30.8649527852034, 107.366624806482 30.8649626185929, 107.366768392003 30.864981089807, 107.367451472333 30.8650899903108, 107.368838482577 30.8652259780571, 107.369963012928 30.865290002113, 107.371563525154 30.8652380570688, 107.372554745109 30.8651821232738, 107.372630579148 30.8651790350083, 107.372706493158 30.86517832323, 107.37346534095 30.865183089142, 107.373625771854 30.8651894159546, 107.373785166883 30.8652063442988, 107.375419902464 30.8654352191313, 107.375614322014 30.8654706892324, 107.375803961062 30.8655219180514, 107.375987107259 30.865588443019, 107.37653594638 30.8658148531592, 107.376813079212 30.8659176752148, 107.377108504448 30.8659165130076, 107.377401171751 30.8659512736156, 107.377685240586 30.8660212633486, 107.377955041987 30.8661250854743, 107.378205191666 30.8662606680872, 107.378430697453 30.8664253054504, 107.378627058917 30.8666157119842, 107.378790357173 30.8668280878271, 107.378917333104 30.8670581946594, 107.379005452405 30.8673014402787, 107.379052956183 30.8675529702388, 107.379058896081 30.8678077647254, 107.379023153225 30.8680607387346, 107.378946440628 30.8683068435548, 107.378830288982 30.8685411675289, 107.378677016134 30.8687590340825, 107.378489680844 30.8689560950639, 107.378272021754 30.8691284175315, 107.378028382779 30.8692725622555, 107.377763626415 30.8693856523664))')
        setTimeout(() => {
          this.locationByLineString('LINESTRING (107.360477292 30.8685989360001, 107.359886829 30.8688659790001, 107.359095449 30.8691740470001, 107.358858222 30.8692329400001, 107.358406238 30.869274628, 107.357681215 30.8691627960001, 107.355908307 30.8694223250001, 107.35495588 30.869497218)')
        }, 2000)
      })
    },
    /**
     * @description 线定位
     * @param {wkt}  
     * **/
    locationByLineString(wkt) {
      const { map } = this.$refs['map'].map;
      const geometry = window.Terraformer.WKT.parse(wkt);
      const bbox = turf.bbox(geometry);
      map.fitBounds(bbox, {
        duration: 1 * 1000,
        padding: {
          top: 20,
          bottom: 20,
          left: 60,
          right: 60
        },
      })
    },
    /**
      * @description 生成管线source
      * @param {pipes} 管线集合
      * **/
    createPipeSource(pipes) {
      let source = {
        'type': 'geojson',
        'data': {
          'type': 'FeatureCollection',
          'features': []
        }
      };
      pipes.forEach((pipe) => {
        const { name, wkt } = pipe;
        //线数据
        const geometry = window.Terraformer.WKT.parse(wkt);
        source.data.features.push({
          type: 'Fetaure',
          geometry,
          properties: {
            ...pipe
          }
        })
        //中心点数据
        const centerGeometry = turf.center(geometry);
        source.data.features.push({
          type: 'Fetaure',
          geometry: centerGeometry.geometry,
          properties: {
            name,
          },
        })
      })
      return source;
    },
    /**
     * @description 生成点数据源
     * @param {points} 点集合
     * **/
    createPointSource(points) {
      let source = {
        'type': 'geojson',
        'data': {
          'type': 'FeatureCollection',
          'features': []
        }
      };
      points.forEach(point => {
        const { wkt } = point;
        const geometry = window.Terraformer.WKT.parse(wkt);
        source.data.features.push({
          type: 'Fetaure',
          geometry,
          properties: {
            ...point
          },
        })
      })

      return source;
    },
    /**
     * @description 管道渲染
     * @param {pipes} 管线集合
     * **/
    pipeRender(pipes) {
      const { map } = this.$refs['map'].map;
      const source = this.createPipeSource(pipes);
      //管线图层
      map.addLayer({
        id: PIPE_LAYER_ID,
        type: 'line',
        source: source,
        layout: {
          'line-cap': 'round',
          'line-join': 'round'
        },
        paint: {
          'line-color': "yellow",
          'line-width': 5
        },
        filter: ['==', '$type', 'LineString']
      })
      //管线名称图层
      map.addLayer({
        id: 'pipe-name',
        type: 'symbol',
        source: source,
        layout: {
          'text-rotate': 360,
          'text-letter-spacing': 0,
          'text-field': ['get', 'name'],
          'text-rotation-alignment': 'viewport',
          'text-size': 14,
          'text-allow-overlap': true,
          'text-ignore-placement': true,
          'symbol-placement': 'point',
          'text-font': ['literal', [' bold  arial,sans-serif']],
        },
        paint: {
          'text-color': '#fff'
        },
        filter: ['==', '$type', 'Point'],
        minzoom: 12,
        maxzoom: 0
      })
    },
    /**
     * @description 渲染管线影响半径
     * @param {wkt} 影响半径wkt
     * **/
    pipeRadiusRender(wkt) {
      const { map } = this.$refs['map'].map;
      const id = 'pipe-radius';
      const geometry = window.Terraformer.WKT.parse(wkt);
      map.addLayer({
        id,
        type: 'fill',
        source: {
          type: 'geojson',
          data: {
            'type': 'Feature',
            'geometry': geometry
          }
        },
        paint: {
          'fill-color': '#ffff00',
          'fill-opacity': 0.3,
          'fill-outline-color': '#ffff00'
        }
      }, PIPE_LAYER_ID)
    },
    /**
     * @description 管道分段节点
     * @param {wkts} 节点集合
     * **/
    async pipeSectionPointRender(wkts) {
      const { map } = this.$refs['map'].map;
      const img = require('@/assets/images/分段点位.png');
      const id = 'section-point';
      const source = this.createPointSource(wkts.map(wkt => {
        return {
          wkt
        }
      }));
      await this.loadImage(img);
      map.addLayer({
        id,
        type: 'symbol',
        source,
        layout: {
          "icon-image": img,
          "icon-anchor": "center",
          "icon-size": 0.2,
          "icon-allow-overlap": true,
          "icon-ignore-placement": true,
          "symbol-placement": "point",
          "text-rotation-alignment": "viewport",
          "icon-offset": [0, -40],
        },
        minzoom: 12,
        maxzoom: 0
      })
    },
    /**
     * @description 加载图片
     * @param {img} 
     * **/
    async loadImage(img) {
      const { map } = this.$refs['map'].map;
      return new Promise((resolve, reject) => {
        if (map.hasImage(img)) {
          resolve();
        } else {
          map.loadImage(img, (err, data) => {
            if (err) {
              reject();
            } else {
              map.addImage(img, data);
              resolve();
            }
          })
        }
      })
    },
    /**
     * @description 场站、阀室
     * @param {stations} 场站集合
     * **/
    async stationRender(stations) {
      const id = 'station';
      const { map } = this.$refs['map'].map;

      Promise.all(stations.map((station) => {
        const { type } = station;
        const image = STATION_IMG_MAP[type] || STATION_IMG_MAP[99];
        station._image = image;
        return this.loadImage(image);
      })).then(() => {
        const source = this.createPointSource(stations);
        map.addLayer({
          id,
          type: 'symbol',
          source,
          layout: {
            "icon-image": ['get', '_image'],
            "icon-anchor": "center",
            "icon-size": 0.3,
            "symbol-placement": "point",
            "text-rotation-alignment": "viewport",
            "text-field": ['get', 'name'],
            "text-size": 10,
            "text-ignore-placement": false,
            "icon-allow-overlap": false,
            "text-offset": [0, 2],
          },
          paint: {
            "text-color": "#fff",
          },
          minzoom: 12,
          maxzoom: 0
        })
      })
    },
    /**
     * @description 人居、特定场所、易燃易爆场所
     * @param {data} 数据集合
     * @param {type} 1.人居 2.特定场所 3.易燃易爆场所
     * **/

    async renderMarkerByType(data, type) {
      const { map } = this.$refs['map'].map;
      const MARKER_MAP = {
        1: require('@/assets/images/人居.png'),
        2: require('@/assets/images/特定场所.png'),
        // 3:require('@/assets/images/易燃易爆')
      }
      const id = 'marker-' + type
      const img = MARKER_MAP[type];
      await this.loadImage(img);
      const source = this.createPointSource(data);
      map.addLayer({
        id,
        type: 'symbol',
        source,
        layout: {
          "icon-image": img,
          "icon-anchor": "center",
          "icon-size": 0.3,
          "symbol-placement": "point",
          "icon-allow-overlap": false,
        },
        minzoom: 12,
        maxzoom: 0
      })

      //人居添加hover popup
      if (type === 1) {
        const popup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false
        })
        map.on('mouseenter', id, (e) => {
          map.getCanvas().style.cursor = 'pointer';
          const coordinates = e.features[0].geometry.coordinates.slice();
          const description = `<span>${e.features[0].properties.name}</span>`;
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
          popup.setLngLat(coordinates).setHTML(description).addTo(map);
        })

        map.on('mouseleave', id, () => {
          map.getCanvas().style.cursor = '';
          popup.remove();
        })
      }
    },

    /**
     * @description 高后果区等级
     * @param {data} 高后果区数据集合
     * **/
    sectionLevelRender(data) {
      const { map } = this.$refs['map'].map;
      const id = 'section-level';
      const source = this.createPipeSource(data);
      map.addLayer({
        id,
        type: 'line',
        source: source,
        layout: {
          'line-cap': 'round',
          'line-join': 'round'
        },
        paint: {
          "line-color": [
            "match",
            ["get", "level"],
            0, '#00B725',
            1, '#F7A830',
            2, '#FE7E0E',
            3, '#EE5D4F',
            'yellow'
          ],

          'line-width': 5
        },
        filter: ['==', '$type', 'LineString']
      }, 'pipe-name')

    },
    resize() {
      this.$refs['map'].resize();
    }
  }
}
</script>

<style lang="scss" scoped>
::v-deep .mapboxgl-popup {
  max-width: 200px;
  font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
  top: -20px;
}

.map-container {
  width: 100%;
  height: 100%;

  ::v-deep .map-type-controller {
    display: none;
  }
}
</style>
